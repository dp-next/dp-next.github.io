<script>
(() => {
  const toPath = (href) => {
    try {
      return new URL(href, window.location.origin).pathname;
    } catch {
      return href;
    }
  };

  const findLanguageSegment = (pathname) => {
    const match = pathname.match(/\/(da|en)(?:\/|$)/);
    if (!match || match.index === undefined) {
      return null;
    }
    return {
      lang: match[1],
      index: match.index,
      prefix: pathname.slice(0, match.index),
    };
  };

  const joinWithPrefix = (prefix, relativePath) => `${prefix}${relativePath}`.replace(/\/+/g, "/");

  const languageSegment = findLanguageSegment(window.location.pathname);
  const basePrefix = languageSegment ? languageSegment.prefix : "";

  const withBasePrefix = (path) => {
    if (!path || !path.startsWith("/")) {
      return path;
    }
    if (!languageSegment) {
      return path;
    }
    return joinWithPrefix(basePrefix, path);
  };

  const isEnglishPath = (pathname) =>
    /\/(en)(?:\/|$)/.test(pathname);

  const isDanishPath = (pathname) =>
    /\/(da)(?:\/|$)/.test(pathname);

  const getLanguagePaths = (pathname) => {
    const segment = findLanguageSegment(pathname);
    if (segment && segment.lang === "en") {
      let daPath = pathname.replace(/\/(en)(?=\/|$)/, "/da");
      if (daPath.endsWith("/da") || daPath.endsWith("/da/")) {
        daPath = withBasePrefix("/da/1homepage/index.html");
      }
      return { daPath, enPath: pathname };
    }

    if (segment && segment.lang === "da") {
      let enPath = pathname.replace(/\/(da)(?=\/|$)/, "/en");
      if (enPath.endsWith("/en") || enPath.endsWith("/en/")) {
        enPath = withBasePrefix("/en/1homepage/index.html");
      }
      return { daPath: pathname, enPath };
    }

    return {
      daPath: withBasePrefix("/da/1homepage/index.html"),
      enPath: withBasePrefix("/en/1homepage/index.html"),
    };
  };

  const { daPath, enPath } = getLanguagePaths(window.location.pathname);
  const isEn = isEnglishPath(window.location.pathname);

  document.querySelectorAll("a[href]").forEach((link) => {
    const href = link.getAttribute("href") || "";
    if (!href.startsWith("/") || href.startsWith("//")) {
      return;
    }
    if (/^\/(da|en)(\/|$)/.test(href)) {
      link.setAttribute("href", withBasePrefix(href));
    }
  });

  document.querySelectorAll("a.dropdown-item").forEach((link) => {
    const txt = (link.textContent || "").toLowerCase();
    if (txt.includes("dansk")) {
      link.setAttribute("href", daPath);
    }
    if (txt.includes("english")) {
      link.setAttribute("href", enPath);
    }
  });

  const danishLabels = new Set(["deltager", "forsker", "om os"]);
  const englishLabels = new Set(["participant", "researcher", "who we are"]);
  const sharedLabels = new Set(["publications", "support"]);

  const shouldKeepLink = (link) => {
    const text = (link.textContent || "").trim().toLowerCase();
    const href = toPath(link.getAttribute("href") || "");

    if (text === "language") return true;
    if (text === "work packages") return true;
    if (text.includes("dansk") || text.includes("english")) return true;

    if (text.startsWith("wp")) {
      return isEn ? href.includes("/en/") : href.includes("/da/");
    }

    if (sharedLabels.has(text)) {
      return isEn ? href.includes("/en/") : href.includes("/da/");
    }

    if (isEn) {
      if (danishLabels.has(text)) return false;
      if (englishLabels.has(text)) return true;
    } else {
      if (englishLabels.has(text)) return false;
      if (danishLabels.has(text)) return true;
    }
    return true;
  };

  document.querySelectorAll(".navbar a.nav-link, .navbar a.dropdown-item").forEach((link) => {
    if (!shouldKeepLink(link)) {
      const li = link.closest("li");
      if (li) li.remove();
    }
  });

  const seenTopLevel = new Set();
  document.querySelectorAll(".navbar .navbar-nav > .nav-item > .nav-link").forEach((link) => {
    const key = (link.textContent || "").trim().toLowerCase();
    if (!key) return;
    if (seenTopLevel.has(key)) {
      const li = link.closest(".nav-item");
      if (li) li.remove();
      return;
    }
    seenTopLevel.add(key);
  });

  const brand = document.querySelector("a.navbar-brand");
  if (brand) {
    brand.setAttribute(
      "href",
      isEnglishPath(window.location.pathname)
        ? withBasePrefix("/en/1homepage/index.html")
        : withBasePrefix("/da/1homepage/index.html")
    );
  }
})();
</script>